---
services:
  database:
    environment:
      # Increase transaction memory limit from 4 GiB to 8 GiB
      - NEO4J_dbms_memory_transaction_total_max=8g
      # Also increase heap and page cache for better performance
      - NEO4J_dbms_memory_heap_initial__size=2g
      - NEO4J_dbms_memory_heap_max__size=4g
      - NEO4J_dbms_memory_pagecache_size=2g

  # Expose prefect UI
  task-manager:
    ports:
      - "4200:4200"

  # Mount local repository for local development
  # Used when INFRAHUB_GIT_LOCAL=true to work with local generator/transform changes
  task-worker:
    volumes:
      - ./:/upstream

  streamlit-service-catalog:
    build:
      context: ./service_catalog
      dockerfile: Dockerfile
    container_name: service-catalog
    ports:
      - "8501:8501"
    environment:
      - INFRAHUB_ADDRESS=http://infrahub-server:8000
      - INFRAHUB_UI_URL=http://localhost:8000
      - INFRAHUB_API_TOKEN=${INFRAHUB_API_TOKEN:-06438eb2-8019-4776-878c-0941b1f1d1ec}
      - DEFAULT_BRANCH=main
      - GENERATOR_WAIT_TIME=60
    volumes:
      - ./service_catalog:/app
      - ./objects:/objects:ro
      - ./docs/static/img:/app/assets:ro
    depends_on:
      - infrahub-server
    profiles:
      - service-catalog
    networks:
      - default
